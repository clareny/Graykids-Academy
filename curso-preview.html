<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <link rel="icon" href="Images/Graykids Academy Logo.png">
    <link rel="stylesheet" href="CSS/Normalize.css">
    <link rel="stylesheet" href="CSS/estilos.css">
    <script src="js/header.js" defer></script>
    <script src="js/courses-loader.js"></script>
    <title>Resumen del Curso</title>
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div class="header__container container">
            <div class="header__logo">
                <a href="index.html">
                    <img src="Images/Graykids Academy Logo.png" alt="Graykids Academy Logo" class="header__logo-img">
                    <span class="header__logo-text">GRAYKIDS ACADEMY</span>
                </a>
            </div>
            <button class="header__toggle" type="button" aria-expanded="false" aria-controls="mainNavigation" aria-label="Abrir men√∫ de navegaci√≥n">
                <svg class="header__toggle-icon header__toggle-icon--menu" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M4 6h16v2H4zM4 11h16v2H4zM4 16h16v2H4z"></path>
                </svg>
                <svg class="header__toggle-icon header__toggle-icon--close" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: currentColor;">
                    <path d="m16.192 6.344-4.243 4.242-4.242-4.242-1.414 1.414L10.535 12l-4.242 4.242 1.414 1.414 4.242-4.242 4.243 4.242 1.414-1.414L13.364 12l4.242-4.242z"></path>
                </svg>
            </button>
            <div class="header__menu" id="mainNavigation">
                <button class="header__menu-close" type="button" aria-label="Cerrar men√∫">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="m16.192 6.344-4.243 4.242-4.242-4.242-1.414 1.414L10.535 12l-4.242 4.242 1.414 1.414 4.242-4.242 4.243 4.242 1.414-1.414L13.364 12l4.242-4.242z"></path>
                    </svg>
                </button>
                <nav class="header__nav">
                    <a href="cursos.html" class="header__link">
                        <span class="header__link-icon" aria-hidden="true">‚ú¶</span>
                        <span class="header__link-label">Cursos</span>
                        <span class="header__link-trail" aria-hidden="true">‚ñπ</span>
                    </a>
                    <a href="GraykidsMembers.html" class="header__link">
                        <span class="header__link-icon" aria-hidden="true">‚ú¶</span>
                        <span class="header__link-label">Graykids Members</span>
                        <span class="header__link-trail" aria-hidden="true">‚ñπ</span>
                    </a>
                    <a href="Discord.html" class="header__link">
                        <span class="header__link-icon" aria-hidden="true">‚ú¶</span>
                        <span class="header__link-label">Discord</span>
                        <span class="header__link-trail" aria-hidden="true">‚ñπ</span>
                    </a>
                    <a href="librerias.html" class="header__link">
                        <span class="header__link-icon" aria-hidden="true">‚ú¶</span>
                        <span class="header__link-label">Librer√≠as</span>
                        <span class="header__link-trail" aria-hidden="true">‚ñπ</span>
                    </a>
                    <a href="index.html#faq" class="header__link">
                        <span class="header__link-icon" aria-hidden="true">‚ú¶</span>
                        <span class="header__link-label">FAQ</span>
                        <span class="header__link-trail" aria-hidden="true">‚ñπ</span>
                    </a>
                </nav>
                <span id="headerAuthButton" class="header__auth">
                    <a href="Login.html" class="btn btn--outline">Entrar</a>
                </span>
            </div>
        </div>
        <div class="header__overlay" hidden></div>
    </header>

    <!-- HERO -->
    <section class="courses-hero">
        <div class="courses-hero__container container">
            <p class="course-preview__badge" id="courseBadge"></p>
            <h1 class="courses-hero__title" id="courseTitle">Curso</h1>
            <p class="courses-hero__subtitle" id="courseSubtitle">Descubre qu√© aprender√°s antes de comenzar</p>
        </div>
    </section>

    <!-- COURSE PREVIEW -->
    <section class="course-preview">
        <div class="course-preview__container container">
            <div class="course-preview__media" id="presentationWrapper">
                <div class="course-preview__media-empty">
                    <p>Este curso todav√≠a no tiene un video de presentaci√≥n. ¬°Vuelve pronto!</p>
                </div>
            </div>

            <aside class="course-preview__sidebar" id="courseSidebar">
                <div class="course-preview__status" id="courseStatus"></div>
                <p class="course-preview__description" id="courseDescription"></p>
                <ul class="course-preview__stats" id="courseStats"></ul>
                <div class="course-preview__ctas" id="courseCtas"></div>
            </aside>
        </div>
    </section>

    <!-- MODULES -->
    <section class="course-preview__modules">
        <div class="course-preview__modules-container container" id="modulesContainer">
            <h2 class="course-preview__modules-title">Contenido del curso</h2>
            <p class="course-preview__modules-subtitle">Revisa los m√≥dulos y lecciones que tendr√°s disponibles</p>
            <div class="course-preview__modules-grid" id="modulesGrid"></div>
        </div>
    </section>

    <!-- CTA -->
    <section class="course-preview__cta">
        <div class="course-preview__cta-container container">
            <div>
                <h3 class="course-preview__cta-title">¬øListo para dar el siguiente paso?</h3>
                <p class="course-preview__cta-text">Empieza el curso o descubre m√°s formaci√≥n personalizada en nuestro campus.</p>
            </div>
            <div class="course-preview__cta-actions">
                <a href="cursos.html" class="btn btn--outline">Ver todos los cursos</a>
                <a href="campus.html" class="btn btn--primary">Ir al campus</a>
            </div>
        </div>
    </section>

    <!-- FOOTER -->
    <footer class="footer">
        <div class="footer__container container">
            <div class="footer__logo">
                <img src="Images/Graykids Academy Logo.png" alt="Graykids Academy Logo" class="footer__logo-img">
            </div>
            <div class="footer__links">
                <a href="contacto.html" class="footer__link">Contact</a>
                <a href="#" class="footer__link">T√©rminos y Condiciones</a>
                <a href="index.html#faq" class="footer__link">FAQ</a>
            </div>
            <p class="footer__copyright">¬© 2025 Graykids Academy</p>
        </div>
    </footer>

    <script>
        (function initCoursePreview() {
            const params = new URLSearchParams(window.location.search);
            const courseId = params.get('course');

            if (!courseId) {
                renderError('No se encontr√≥ el curso solicitado.');
                return;
            }

            const courseInfo = Object.assign({ id: courseId }, getCourseInfo(courseId) || {});
            const coursesData = JSON.parse(localStorage.getItem('coursesData') || '{}');
            const courseData = coursesData[courseId] || { modules: [] };

            document.title = `${courseInfo.name || 'Curso'} - Presentaci√≥n`;

            renderHero(courseInfo);
            renderPresentation(courseInfo.presentationVideoUrl);
            renderSidebar(courseInfo, courseData);
            renderModules(courseData.modules || []);
        })();

        function renderHero(course) {
            const badge = document.getElementById('courseBadge');
            const title = document.getElementById('courseTitle');
            const subtitle = document.getElementById('courseSubtitle');

            if (course.icon) {
                title.textContent = `${course.icon} ${course.name || 'Curso'}`;
            } else {
                title.textContent = course.name || 'Curso';
            }

            badge.textContent = course.level ? `Nivel ${course.level}` : '';
            subtitle.textContent = course.description ? course.description : 'Descubre qu√© aprender√°s antes de comenzar';
        }

        function renderPresentation(url) {
            const wrapper = document.getElementById('presentationWrapper');
            if (!wrapper) return;

            wrapper.innerHTML = '';

            if (!url) {
                wrapper.innerHTML = `
                    <div class="course-preview__media-empty">
                        <p>Este curso todav√≠a no tiene un video de presentaci√≥n. ¬°Pronto a√±adiremos uno!</p>
                    </div>
                `;
                return;
            }

            const embed = buildVideoEmbed(url);
            wrapper.innerHTML = embed || `
                <div class="course-preview__media-empty">
                    <p>No se pudo reproducir el video proporcionado. Revisa la URL en la configuraci√≥n del curso.</p>
                </div>
            `;
        }

        function buildVideoEmbed(url) {
            if (!url) return '';
            const cleanUrl = url.trim();
            const lower = cleanUrl.toLowerCase();

            // YouTube enlaces
            if (lower.includes('youtube.com/watch') || lower.includes('youtu.be/')) {
                const videoId = extractYouTubeId(cleanUrl);
                if (videoId) {
                    const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&playsinline=1&rel=0`;
                    return `<div class="course-preview__media-frame"><iframe src="${embedUrl}" title="Video de presentaci√≥n" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`;
                }
            }

            // Vimeo
            if (lower.includes('vimeo.com/')) {
                const vimeoId = cleanUrl.split('/').pop();
                if (vimeoId) {
                    const embedUrl = `https://player.vimeo.com/video/${vimeoId}?autoplay=1&muted=1&playsinline=1`;
                    return `<div class="course-preview__media-frame"><iframe src="${embedUrl}" title="Video de presentaci√≥n" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe></div>`;
                }
            }

            // Archivos directos (mp4, webm, ogg, m3u8)
            if (/(\.mp4|\.webm|\.ogg|\.m3u8)$/i.test(lower)) {
                return `<div class="course-preview__media-frame"><video controls autoplay muted playsinline preload="metadata"><source src="${cleanUrl}"></video></div>`;
            }

            // Fallback iframe
            const separator = cleanUrl.includes('?') ? '&' : '?';
            const autoplayUrl = `${cleanUrl}${separator}autoplay=1&muted=1`;
            return `<div class="course-preview__media-frame"><iframe src="${autoplayUrl}" title="Video de presentaci√≥n" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe></div>`;
        }

        function extractYouTubeId(url) {
            if (!url) return null;
            const clean = url.trim();
            try {
                const parsed = new URL(clean);
                const host = parsed.hostname.replace(/^www\./, '').toLowerCase();
                const pathSegments = parsed.pathname.split('/').filter(Boolean);

                if (host === 'youtu.be') {
                    return pathSegments[0] ? pathSegments[0].split('?')[0] : null;
                }

                if (host.endsWith('youtube.com')) {
                    if (parsed.searchParams.has('v')) {
                        return parsed.searchParams.get('v');
                    }

                    if (pathSegments.length) {
                        const [first, second] = pathSegments;
                        if (['embed', 'shorts', 'live', 'watch', 'v'].includes(first) && second) {
                            return second;
                        }
                        if (first && first.length >= 6 && !second) {
                            return first;
                        }
                    }
                }
            } catch (error) {
                // ignore and fallback to regex
            }

            const fallbackMatch = clean.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
            return fallbackMatch ? fallbackMatch[1] : null;
        }

        function renderSidebar(course, courseData) {
            const statusContainer = document.getElementById('courseStatus');
            const description = document.getElementById('courseDescription');
            const statsList = document.getElementById('courseStats');
            const ctas = document.getElementById('courseCtas');

            if (description) {
                description.textContent = course.description || 'Este curso a√∫n no tiene una descripci√≥n detallada.';
            }

            if (statusContainer) {
                const status = (course.status || '').toLowerCase();
                const statusLabel = status === 'available' ? 'Disponible' : status === 'pre-sale' ? 'Pre-venta' : 'Pr√≥ximamente';
                statusContainer.innerHTML = `<span class="course-preview__status-badge course-preview__status-badge--${status || 'soon'}">${statusLabel}</span>`;
            }

            if (statsList) {
                statsList.innerHTML = '';
                const modules = courseData.modules || [];
                const totalLessons = modules.reduce((total, module) => total + (module.lessons ? module.lessons.length : 0), 0);
                const priceValue = typeof course.price === 'number' ? course.price : parseFloat(course.price);
                const priceLabel = !Number.isNaN(priceValue) && Number.isFinite(priceValue)
                    ? `$${priceValue.toFixed(2)}`
                    : (course.price || 'Por anunciar');

                statsList.innerHTML = `
                    <li><span>üì¶ M√≥dulos:</span><strong>${modules.length}</strong></li>
                    <li><span>üé¨ Lecciones:</span><strong>${totalLessons}</strong></li>
                    <li><span>‚è±Ô∏è Duraci√≥n estimada:</span><strong>${course.hours || 'Pr√≥ximamente'}</strong></li>
                    <li><span>üí∞ Precio:</span><strong>${priceLabel}</strong></li>
                `;
            }

            if (ctas) {
                const status = (course.status || '').toLowerCase();
                const isAvailable = status === 'available' || status === 'pre-sale';

                const purchaseUrl = `checkout.html?type=course&id=${encodeURIComponent(course.id || '')}`;
                ctas.innerHTML = '';

                if (isAvailable && course.id) {
                    const buyButton = document.createElement('a');
                    buyButton.className = 'btn btn--primary btn--block';
                    buyButton.href = purchaseUrl;
                    buyButton.textContent = status === 'pre-sale' ? 'Comprar en Pre-Venta' : 'Comprar Curso';
                    ctas.appendChild(buyButton);
                } else {
                    const notify = document.createElement('div');
                    notify.className = 'course-preview__notice';
                    notify.textContent = 'Este curso a√∫n no est√° disponible para la compra. Suscr√≠bete a nuestras novedades para enterarte del lanzamiento.';
                    ctas.appendChild(notify);
                }

                const backButton = document.createElement('a');
                backButton.className = 'btn btn--outline btn--block';
                backButton.href = 'cursos.html';
                backButton.textContent = 'Volver a cursos';
                ctas.appendChild(backButton);
            }
        }

        function renderModules(modules) {
            const modulesGrid = document.getElementById('modulesGrid');
            if (!modulesGrid) return;

            modulesGrid.innerHTML = '';

            if (!modules || modules.length === 0) {
                modulesGrid.innerHTML = `
                    <div class="course-preview__modules-empty">
                        <p>Este curso todav√≠a no tiene m√≥dulos publicados. El equipo los a√±adir√° en breve.</p>
                    </div>
                `;
                return;
            }

            modules.forEach((module, index) => {
                const lessons = Array.isArray(module.lessons) ? module.lessons : [];
                const lessonsHtml = lessons.length > 0
                    ? lessons.map((lesson, lessonIndex) => `
                        <li class="module-accordion__lesson">
                            <span class="module-accordion__lesson-index">${lessonIndex + 1}.</span>
                            <div class="module-accordion__lesson-meta">
                                <strong>${lesson.title || 'Lecci√≥n sin t√≠tulo'}</strong>
                                <span>${lesson.duration || 'Duraci√≥n N/D'}</span>
                            </div>
                        </li>
                    `).join('')
                    : '<div class="module-accordion__empty">A√∫n no hay lecciones publicadas en este m√≥dulo.</div>';

                const accordion = document.createElement('details');
                accordion.className = 'module-accordion';
                if (index === 0) {
                    accordion.open = true;
                }

                accordion.innerHTML = `
                    <summary>
                        <div class="module-accordion__meta">
                            <span class="module-accordion__index">M√≥dulo ${index + 1}</span>
                            <h4 class="module-accordion__title">${module.title || 'M√≥dulo sin t√≠tulo'}</h4>
                        </div>
                        <span class="module-accordion__toggle" aria-hidden="true">+</span>
                    </summary>
                    <div class="module-accordion__content">
                        ${lessons.length > 0
                            ? `<ul class="module-accordion__lessons">${lessonsHtml}</ul>`
                            : lessonsHtml}
                    </div>
                `;

                modulesGrid.appendChild(accordion);
            });
        }

        function renderError(message) {
            const hero = document.querySelector('.courses-hero__container');
            if (hero) {
                hero.innerHTML = `<h1 class="courses-hero__title">Curso no encontrado</h1><p class="courses-hero__subtitle">${message}</p>`;
            }

            const wrapper = document.getElementById('presentationWrapper');
            if (wrapper) {
                wrapper.innerHTML = `<div class="course-preview__media-empty"><p>${message}</p></div>`;
            }

            const modulesGrid = document.getElementById('modulesGrid');
            if (modulesGrid) {
                modulesGrid.innerHTML = `<div class="course-preview__modules-empty"><p>No se pudo cargar la informaci√≥n del curso solicitado.</p></div>`;
            }
        }
    </script>
</body>
</html>

